// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPER_ADMIN
  ADMIN
  RH
  MANAGER
  EMPLOYEE
  TEACHER
  SITE_MANAGER
}

enum OvertimeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PayrollStatus {
  DRAFT
  FINALIZED
  PAID
}

enum ExportFormat {
  CSV
  PDF
}

enum ReportType {
  ATTENDANCE
  PAYROLL
  OVERTIME
}

enum StudentAttendanceStatus {
  PRESENT
  LATE
  ABSENT
}

/// Company classification used by the long-term architecture.
enum CompanyType {
  CORPORATE
  SCHOOL
  CONSTRUCTION
}

/// Person specialization used by unified attendance/events.
enum PersonType {
  EMPLOYEE
  STUDENT
  WORKER
}

/// Raw attendance event type (check-in/out).
enum AttendanceType {
  CHECK_IN
  CHECK_OUT
}

/// Daily attendance status for summaries.
enum AttendanceStatus {
  ON_TIME
  LATE
  EARLY_LEAVE
  ABSENT
  HOLIDAY
  SICK_LEAVE
}

enum SalaryType {
  MONTHLY
  HOURLY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

enum AuditEntity {
  USER
  ATTENDANCE
  PAYROLL
}

model Company {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  /// Optional classification to guide feature flags and UI.
  type      CompanyType @default(CORPORATE)
  isActive  Boolean  @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  /// New architecture: identity/person layer for all profiles.
  persons   Person[]
  employees Employee[]
  workers   Worker[]
  attendance Attendance[]
  attendanceEvents AttendanceEvent[]
  attendanceDailySummaries AttendanceDailySummary[]

  schedules Schedule[]
  overtime Overtime[]
  attendanceSummaries AttendanceSummary[]
  payrolls Payroll[]
  payrollPeriods PayrollPeriod[]
  payrollLines PayrollLine[]
  contracts Contract[]
  payrollExports PayrollExport[]
  reports Report[]

  schoolClasses SchoolClass[]
  courses Course[]
  students Student[]
  studentAttendance StudentAttendance[]

  leaveTypes LeaveType[]
  leaveBalances LeaveBalance[]
  leaveRequests LeaveRequest[]
  publicHolidays PublicHoliday[]

  constructionSites ConstructionSite[]
  constructionTeams ConstructionTeam[]
  constructionWorkers ConstructionWorker[]
  siteAttendance SiteAttendance[]
  auditLogs AuditLog[]
  userRoles UserRole[]
  devices Device[]
  periodClosures PeriodClosure[]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  passwordHash String
  roles     Role[]  @default([EMPLOYEE])
  isActive  Boolean  @default(true)
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  /// Optional link to the identity/person layer (progressive migration).
  personId  String? @unique
  person    Person? @relation(fields: [personId], references: [id])
  employee  Employee? @relation("UserEmployee")
  /// New RBAC table for more granular role management.
  userRoles UserRole[]
  refreshTokenHash String?
  refreshTokenExpiresAt DateTime?
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendance Attendance[]
  overtimeRequests Overtime[] @relation("OvertimeRequester")
  overtimeApprovals Overtime[] @relation("OvertimeApprover")
  studentAttendanceRecords StudentAttendance[] @relation("StudentAttendanceRecorder")
  attendanceValidations AttendanceDailySummary[] @relation("AttendanceDailyValidator")
  leaveValidations LeaveRequest[] @relation("LeaveValidator")
  payrollPeriodClosures PayrollPeriod[] @relation("PayrollPeriodCloser")
  auditLogs AuditLog[]
}

model Attendance {
  id          String   @id @default(uuid())
  userId      String
  companyId   String
  checkInAt   DateTime
  checkOutAt  DateTime?
  deletedAt   DateTime?

  user        User     @relation(fields: [userId], references: [id])
  company     Company  @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Schedule {
  id        String   @id @default(uuid())
  companyId String
  name      String
  startTime String
  endTime   String
  daysOfWeek String[]
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  employees Employee[] @relation("EmployeeSchedule")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Overtime {
  id        String   @id @default(uuid())
  companyId String
  userId    String
  date      DateTime
  hours     Float
  reason    String?
  status    OvertimeStatus @default(PENDING)
  approvedByUserId String?
  approvedAt DateTime?
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  user      User @relation("OvertimeRequester", fields: [userId], references: [id])
  approvedBy User? @relation("OvertimeApprover", fields: [approvedByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AttendanceSummary {
  id        String   @id @default(uuid())
  companyId String
  periodStart DateTime
  periodEnd DateTime
  totalHours Float
  overtimeHours Float
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  payrolls  Payroll[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payroll {
  id        String   @id @default(uuid())
  companyId String
  attendanceSummaryId String
  periodStart DateTime
  periodEnd DateTime
  grossPay Float
  netPay Float
  status PayrollStatus @default(DRAFT)
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  attendanceSummary AttendanceSummary @relation(fields: [attendanceSummaryId], references: [id])
  exports PayrollExport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PayrollExport {
  id        String   @id @default(uuid())
  companyId String
  payrollId String
  format    ExportFormat
  path      String
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  payroll   Payroll @relation(fields: [payrollId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Report {
  id        String   @id @default(uuid())
  companyId String
  type      ReportType
  periodStart DateTime
  periodEnd DateTime
  data      Json
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PeriodClosure {
  id        String   @id @default(uuid())
  companyId String
  periodStart DateTime
  periodEnd DateTime
  closedAt  DateTime @default(now())

  company   Company @relation(fields: [companyId], references: [id])
}

model SchoolClass {
  id        String   @id @default(uuid())
  companyId String
  name      String
  code      String
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  courses   Course[]
  students  Student[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
}

model Course {
  id        String   @id @default(uuid())
  companyId String
  classId   String
  name      String
  code      String
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  class     SchoolClass @relation(fields: [classId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
}

model Student {
  id        String   @id @default(uuid())
  companyId String
  classId   String
  firstName String
  lastName  String
  email     String?
  /// Optional link to Person for long-term identity unification.
  personId  String?  @unique
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  class     SchoolClass @relation(fields: [classId], references: [id])
  person    Person? @relation(fields: [personId], references: [id])
  attendance StudentAttendance[]
  attendanceEvents AttendanceEvent[]
  dailySummaries AttendanceDailySummary[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StudentAttendance {
  id        String   @id @default(uuid())
  companyId String
  studentId String
  date      DateTime
  status    StudentAttendanceStatus
  note      String?
  recordedByUserId String?
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  student   Student @relation(fields: [studentId], references: [id])
  recordedBy User? @relation("StudentAttendanceRecorder", fields: [recordedByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, date])
}

model ConstructionSite {
  id        String   @id @default(uuid())
  companyId String
  name      String
  location  String?
  latitude  Float?
  longitude Float?
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  teams     ConstructionTeam[]
  attendance SiteAttendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ConstructionTeam {
  id        String   @id @default(uuid())
  companyId String
  siteId    String
  name      String
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  site      ConstructionSite @relation(fields: [siteId], references: [id])
  workers   ConstructionWorker[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ConstructionWorker {
  id        String   @id @default(uuid())
  companyId String
  teamId    String
  name      String
  email     String?
  /// Optional link to Person for long-term identity unification.
  personId  String?  @unique
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  team      ConstructionTeam @relation(fields: [teamId], references: [id])
  person    Person? @relation(fields: [personId], references: [id])
  attendance SiteAttendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteAttendance {
  id        String   @id @default(uuid())
  companyId String
  siteId    String
  workerId  String
  date      DateTime
  checkInAt DateTime
  checkOutAt DateTime?
  latitude  Float?
  longitude Float?
  deletedAt DateTime?

  company   Company @relation(fields: [companyId], references: [id])
  site      ConstructionSite @relation(fields: [siteId], references: [id])
  worker    ConstructionWorker @relation(fields: [workerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workerId, date])
}

model AuditLog {
  id        String   @id @default(uuid())
  companyId String
  action    String
  entity    String
  entityId  String
  /// Structured audit fields for long-term analytics.
  actionType AuditAction?
  entityType AuditEntity?
  ip        String?
  userId    String?
  data      Json?
  createdAt DateTime @default(now())

  company   Company @relation(fields: [companyId], references: [id])
  user      User? @relation(fields: [userId], references: [id])
}

/// New RBAC table to replace Role[] progressively (non-breaking).
model UserRole {
  id        String   @id @default(uuid())
  companyId String
  role      Role
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  deletedAt DateTime?
  createdAt DateTime @default(now())

  company   Company @relation(fields: [companyId], references: [id])

  @@unique([userId, role])
  @@index([companyId])
}

/// Person identity layer shared by employee/student/worker profiles.
model Person {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  phone     String?
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  user      User?
  employee  Employee?
  student   Student?
  worker    Worker?
  constructionWorker ConstructionWorker?
  devices   Device[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([companyId])
}

/// Employee profile used by HR/Payroll, linked to Person and optionally User.
model Employee {
  id         String   @id @default(uuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])

  personId   String   @unique
  person     Person   @relation(fields: [personId], references: [id])

  userId     String?  @unique
  user       User?    @relation("UserEmployee", fields: [userId], references: [id])

  scheduleId String?
  schedule   Schedule? @relation("EmployeeSchedule", fields: [scheduleId], references: [id])

  attendances AttendanceEvent[]
  dailySummaries AttendanceDailySummary[]
  payrollLines PayrollLine[]
  contracts Contract[]
  leaveBalances LeaveBalance[]
  leaveRequests LeaveRequest[]

  matricule  String?  @unique
  deletedAt  DateTime?
  createdAt  DateTime @default(now())

  @@index([companyId])
}

/// Worker profile for long-term architecture (kept separate from ConstructionWorker).
model Worker {
  id         String   @id @default(uuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])

  personId   String   @unique
  person     Person   @relation(fields: [personId], references: [id])

  attendances AttendanceEvent[]
  dailySummaries AttendanceDailySummary[]

  deletedAt  DateTime?
  createdAt  DateTime @default(now())

  @@index([companyId])
}

/// Unified attendance event stream (non-breaking; legacy Attendance preserved).
model AttendanceEvent {
  id         String   @id @default(uuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])

  type       AttendanceType
  timestamp  DateTime
  date       DateTime @db.Date
  personType PersonType

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])

  studentId  String?
  student    Student?  @relation(fields: [studentId], references: [id])

  workerId   String?
  worker     Worker?   @relation(fields: [workerId], references: [id])

  deviceId   String?
  device     Device? @relation(fields: [deviceId], references: [id])

  createdAt  DateTime @default(now())
  deletedAt  DateTime?

  @@index([companyId, date])
  @@index([date, personType])
}

/// Daily summary for attendance status (separate from payroll AttendanceSummary).
model AttendanceDailySummary {
  id         String   @id @default(uuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])

  date       DateTime @db.Date
  status     AttendanceStatus

  lateMinutes   Int?
  earlyMinutes  Int?
  workedMinutes Int?

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])

  studentId  String?
  student    Student?  @relation(fields: [studentId], references: [id])

  workerId   String?
  worker     Worker?   @relation(fields: [workerId], references: [id])

  validatedByUserId String?
  validatedBy       User? @relation("AttendanceDailyValidator", fields: [validatedByUserId], references: [id])

  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@unique([employeeId, date])
  @@unique([studentId, date])
  @@unique([workerId, date])
  @@index([companyId, date])
}

/// Devices used for anti-fraud or attendance capture.
model Device {
  id       String   @id @default(uuid())
  uuid     String   @unique
  platform String
  model    String

  personId String
  person   Person   @relation(fields: [personId], references: [id])
  attendanceEvents AttendanceEvent[]

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  deletedAt DateTime?
  createdAt DateTime @default(now())

  @@index([companyId])
}

/// Leave configuration per company.
model LeaveType {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  name        String
  code        String
  isPaid      Boolean
  maxDaysYear Int?
  createdAt   DateTime @default(now())
  deletedAt   DateTime?

  balances    LeaveBalance[]
  requests    LeaveRequest[]

  @@unique([companyId, code])
}

/// Leave balance per employee/year.
model LeaveBalance {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  leaveTypeId String
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])
  year        Int
  totalDays   Int
  usedDays    Int @default(0)
  deletedAt   DateTime?

  @@unique([employeeId, leaveTypeId, year])
  @@index([companyId])
}

/// Leave request workflow.
model LeaveRequest {
  id            String   @id @default(uuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  employeeId    String
  employee      Employee @relation(fields: [employeeId], references: [id])
  leaveTypeId   String
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id])
  startDate     DateTime @db.Date
  endDate       DateTime @db.Date
  days          Int
  status        LeaveStatus
  reason        String?
  requestedAt   DateTime @default(now())
  validatedAt   DateTime?
  validatedByUserId String?
  validatedBy   User? @relation("LeaveValidator", fields: [validatedByUserId], references: [id])
  deletedAt     DateTime?

  @@index([companyId, requestedAt])
}

/// Public holidays (global or company-specific).
model PublicHoliday {
  id        String   @id @default(uuid())
  date      DateTime @db.Date
  name      String
  country   String
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])
  deletedAt DateTime?
}

/// Employee contract and base salary definition.
model Contract {
  id         String   @id @default(uuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  salaryType SalaryType
  baseSalary Float
  hourlyRate Float?

  startDate  DateTime @db.Date
  endDate    DateTime?
  deletedAt  DateTime?
}

/// Payroll period (monthly closure).
model PayrollPeriod {
  id        String   @id @default(uuid())
  month     Int
  year      Int
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])

  isClosed  Boolean @default(false)
  closedAt  DateTime?
  closedByUserId String?
  closedBy  User? @relation("PayrollPeriodCloser", fields: [closedByUserId], references: [id])
  deletedAt DateTime?

  lines     PayrollLine[]

  @@unique([month, year, companyId])
  @@index([companyId])
}

/// Payroll line item per employee and period.
model PayrollLine {
  id            String   @id @default(uuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  payrollPeriodId String
  payrollPeriod PayrollPeriod @relation(fields: [payrollPeriodId], references: [id])
  employeeId    String
  employee      Employee @relation(fields: [employeeId], references: [id])

  workedDays    Int
  absentDays    Int
  lateMinutes   Int
  overtimeHours Float

  grossSalary   Float
  deductions    Float
  netSalary     Float
  deletedAt     DateTime?
  createdAt     DateTime @default(now())

  @@index([companyId, createdAt])
}